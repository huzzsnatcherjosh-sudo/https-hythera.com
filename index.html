<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SnapClone</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
:root{
  --bg:#000;
  --text:#fff;
  --accent:#fffc00;
  --card:#111;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;}
body{background:var(--bg);color:var(--text);height:100vh;display:flex;justify-content:center;align-items:center;overflow:hidden;}
input,button,textarea{outline:none;border:none;background:none;color:inherit}
img{max-width:100%;display:block;border-radius:8px}

/* ---------- AUTH ---------- */
.auth{z-index:9999;position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;justify-content:center;align-items:center;gap:15px;padding:30px;text-align:center;}
.auth h1{color:var(--accent);margin-bottom:10px}
.auth input{width:260px;padding:12px 15px;border:2px solid #333;border-radius:25px;color:var(--text);}
.auth button{width:260px;padding:12px;border-radius:25px;background:var(--accent);color:#000;font-weight:bold;cursor:pointer;}

/* ---------- LAYOUT ---------- */
.app{width:100%;max-width:420px;height:100vh;background:var(--bg);display:flex;flex-direction:column;}
header{padding:12px 20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid #222}
header .logo{font-size:22px;font-weight:bold;color:var(--accent)}
header input{flex:1;padding:8px 14px;border:1px solid #333;border-radius:20px;font-size:14px}
header button{font-size:18px;color:var(--accent)}

/* ---------- TABS ---------- */
.tabs{display:flex;border-bottom:1px solid #222}
.tabs button{flex:1;padding:12px;font-size:14px;opacity:.6}
.tabs button.active{opacity:1;border-bottom:2px solid var(--accent)}

/* ---------- LIST ---------- */
.list{flex:1;overflow-y:auto;padding:10px}
.item{background:var(--card);padding:12px;border-radius:12px;margin-bottom:10px;display:flex;align-items:center;gap:12px;cursor:pointer}
.item img.avatar{width:48px;height:48px;border-radius:50%;background:var(--accent);}
.item .name{flex:1;font-weight:600}
.item .snap{font-size:12px;opacity:.6}
.badge{background:var(--accent);color:#000;font-size:11px;padding:2px 6px;border-radius:10px}

/* ---------- CHAT ---------- */
.chat{flex:1;display:flex;flex-direction:column}
.chat-head{padding:12px 20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid #222}
.chat-head img{width:36px;height:36px;border-radius:50%;background:#444;}
.chat-body{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:10px}
.chat-body .snap{align-self:flex-start;background:#222;padding:10px 14px;border-radius:18px;max-width:70%;word-break:break-word}
.chat-body .snap.me{align-self:flex-end;background:var(--accent);color:#000}
.chat-body .snap img{margin-top:6px}
.chat-foot{display:flex;align-items:center;gap:10px;padding:12px;border-top:1px solid #222}
.chat-foot input{flex:1;padding:10px 14px;border:1px solid #333;border-radius:20px}
.chat-foot button{font-size:18px;color:var(--accent)}

/* ---------- VIEW-ONCE ---------- */
.viewonce{z-index:9998;position:fixed;inset:0;background:#000;display:flex;justify-content:center;align-items:center}
.viewonce img{max-height:90%;max-width:90%}
.viewonce .close{position:absolute;top:20px;right:20px;font-size:28px;color:var(--accent);cursor:pointer}
</style>
</head>
<body>

<!-- ================= AUTH ================= -->
<div class="auth" id="auth">
  <h1>SnapClone</h1>
  <input id="authIn" placeholder="Pick a username" maxlength="20">
  <button id="authGo">Sign Up</button>
</div>

<!-- ================= APP ================= -->
<div class="app" id="app" style="display:none">
  <header>
    <div class="logo">SnapClone</div>
    <input id="searchIn" placeholder="Search username to add friend…">
    <button id="addBtn"><i class="fas fa-user-plus"></i></button>
  </header>

  <div class="tabs">
    <button class="active" id="reqTab">Requests <span id="reqCount"></span></button>
    <button id="frTab">Friends</button>
  </div>

  <div class="list" id="list"></div>

  <!-- chat screen (hidden by default) -->
  <div class="chat" id="chat" style="display:none">
    <div class="chat-head">
      <button id="backBtn"><i class="fas fa-arrow-left"></i></button>
      <img id="chatAva">
      <div>
        <div id="chatName">-</div>
        <div style="font-size:12px;opacity:.6">Chat disappears after view</div>
      </div>
    </div>
    <div class="chat-body" id="chatBody"></div>
    <div class="chat-foot">
      <input id="msgIn" placeholder="Type a snap…">
      <button id="imgBtn"><i class="fas fa-camera"></i></button>
      <input type="file" id="imgFile" accept="image/*" style="display:none">
      <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<script>
/* =========================================================
   1.  UTILS / BROADCAST
=========================================================*/
const bc=new BroadcastChannel('snap_clone');
bc.onmessage=({data})=>{
  if(data.type==='req')  handleIncomingReq(data.from);
  if(data.type==='acc')  handleAccepted(data.from);
  if(data.type==='snap') handleSnap(data);
};
function broadcast(msg){bc.postMessage(msg)}

/* =========================================================
   2.  AUTH
=========================================================*/
const authIn=document.getElementById('authIn');
document.getElementById('authGo').onclick=()=>{
  const u=authIn.value.trim().toLowerCase();
  if(!u){alert('Username required');return}
  if(localStorage.getItem('user_'+u)){alert('Username taken');return}
  localStorage.setItem('me',u);
  localStorage.setItem('user_'+u,JSON.stringify({name:u,ava:genAva(u)}));
  init();
};
function genAva(name){
  const c=document.createElement('canvas');c.width=100;c.height=100;
  const ctx=c.getContext('2d');
  ctx.fillStyle='#fffc00';ctx.fillRect(0,0,100,100);
  ctx.fillStyle='#000';ctx.font='bold 40px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.fillText(name.slice(0,2).toUpperCase(),50,50);
  return c.toDataURL();
}

/* =========================================================
   3.  STATE
=========================================================*/
let me=null,activeFriend=null,requests=[],friends=[];

/* =========================================================
   4.  INIT
=========================================================*/
function init(){
  me=localStorage.getItem('me');
  if(!me){document.getElementById('auth').style.display='flex';return}
  document.getElementById('auth').style.display='none';
  document.getElementById('app').style.display='flex';
  loadLists();
  hookEvents();
}
init();

/* =========================================================
   5.  FRIEND REQUESTS
=========================================================*/
document.getElementById('addBtn').onclick=()=>{
  const q=document.getElementById('searchIn').value.trim().toLowerCase();
  if(!q||q===me){alert('Invalid username');return}
  if(!localStorage.getItem('user_'+q)){alert('User not found');return}
  if(requests.includes(q)||friends.includes(q)){alert('Already friends or pending');return}
  // send request
  broadcast({type:'req',from:me});
  alert('Request sent!');
};
function handleIncomingReq(from){
  if(!requests.includes(from))requests.push(from);
  saveLists();loadLists();
}
function acceptRequest(from){
  requests=requests.filter(r=>r!==from);
  if(!friends.includes(from))friends.push(from);
  saveLists();loadLists();
  broadcast({type:'acc',from:me});
}
function handleAccepted(from){
  if(!friends.includes(from))friends.push(from);
  saveLists();loadLists();
}

/* =========================================================
   6.  LISTS UI
=========================================================*/
function saveLists(){
  localStorage.setItem('req',JSON.stringify(requests));
  localStorage.setItem('fr',JSON.stringify(friends));
}
function loadLists(){
  requests=JSON.parse(localStorage.getItem('req')||'[]');
  friends=JSON.parse(localStorage.getItem('fr')||'[]');
  renderList();
}
function renderList(){
  const list=document.getElementById('list');
  const isReq=document.getElementById('reqTab').classList.contains('active');
  list.innerHTML='';
  document.getElementById('reqCount').textContent=requests.length?` (${requests.length})`:'';
  const src=isReq?requests:friends;
  src.forEach(name=>{
    const u=JSON.parse(localStorage.getItem('user_'+name)||'{}');
    const div=document.createElement('div');div.className='item';
    div.innerHTML=`
      <img class="avatar" src="${u.ava||genAva(name)}">
      <div class="name">${name}</div>
      ${isReq?'<button class="badge">Accept</button>':''}
    `;
    div.onclick=(e)=>{
      if(isReq&&e.target.tagName==='BUTTON')acceptRequest(name);
      else openChat(name);
    };
    list.appendChild(div);
  });
}
document.getElementById('reqTab').onclick=()=>{switchTab(true)};
document.getElementById('frTab').onclick=()=>{switchTab(false)};
function switchTab(req){
  document.getElementById('reqTab').classList.toggle('active',req);
  document.getElementById('frTab').classList.toggle('active',!req);
  renderList();
}

/* =========================================================
   7.  CHAT
=========================================================*/
function openChat(name){
  activeFriend=name;
  const u=JSON.parse(localStorage.getItem('user_'+name)||'{}');
  document.getElementById('chatName').textContent=name;
  document.getElementById('chatAva').src=u.ava||genAva(name);
  document.getElementById('list').style.display='none';
  document.querySelector('.tabs').style.display='none';
  document.getElementById('chat').style.display='flex';
  document.getElementById('msgIn').focus();
  // mark any unread as read
  const key='unread_'+me+'_'+name;
  if(localStorage.getItem(key)){localStorage.removeItem(key);loadLists();}
}
document.getElementById('backBtn').onclick=()=>{
  activeFriend=null;
  document.getElementById('chat').style.display='none';
  document.getElementById('list').style.display='block';
  document.querySelector('.tabs').style.display='flex';
};

/* =========================================================
   8.  SEND SNAPS
=========================================================*/
document.getElementById('sendBtn').onclick=()=>sendSnap();
document.getElementById('msgIn').onkeypress=(e)=>{
  if(e.key==='Enter')sendSnap();
};
document.getElementById('imgBtn').onclick=()=>document.getElementById('imgFile').click();
document.getElementById('imgFile').onchange=(e)=>{
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=ev=>sendSnap('',ev.target.result);
  r.readAsDataURL(file);
  e.target.value='';
};
function sendSnap(text='',img=null){
  if(!text&&!img)return;
  const time=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const id=Date.now()+Math.random().toString(36).slice(2);
  const snap={from:me,to:activeFriend,text,img,time,id};
  broadcast({type:'snap',...snap});
  showSnap(snap,true);
  // self-destruct after view
  setTimeout(()=>document.querySelector(`[data-id="${id}"]`)?.remove(),10000);
}
function handleSnap(s){
  if(s.to!==me)return;
  showSnap(s,false);
  // mark unread dot
  const key='unread_'+me+'_'+s.from;
  localStorage.setItem(key,'1');
  loadLists();
}
function showSnap(s,own){
  const body=document.getElementById('chatBody');
  const div=document.createElement('div');div.className='snap '+(own?'me':'');
  div.dataset.id=s.id;
  if(s.text)div.insertAdjacentHTML('afterbegin',`<div>${linkify(s.text)}</div>`);
  if(s.img){
    const img=document.createElement('img');img.src=s.img;
    img.onclick=()=>viewOnce(img);
    div.appendChild(img);
  }
  div.insertAdjacentHTML('beforeend',`<div style="font-size:10px;opacity:.6">${s.time}</div>`);
  body.appendChild(div);
  body.scrollTop=body.scrollHeight;
  // auto-remove
  setTimeout(()=>div.remove(),10000);
}
function viewOnce(img){
  const overlay=document.createElement('div');overlay.className='viewonce';
  const big=document.createElement('img');big.src=img.src;
  const close=document.createElement('div');close.className='close';close.innerHTML='&times;';
  overlay.append(big,close);document.body.appendChild(overlay);
  close.onclick=()=>overlay.remove();
  overlay.onclick=()=>overlay.remove();
  setTimeout(()=>overlay.remove(),5000); // snap timer
}
function linkify(t){
  return t.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank" style="color:inherit;text-decoration:underline">$1</a>');
}

/* =========================================================
   9.  EVENTS
=========================================================*/
function hookEvents(){
  // nothing extra needed
}
</script>
</body>
</html>
